开始的比较晚，大概前天才开始，进度落后不少

### Project1

利用`engine_util`中实现的函数，来填充`standalone_storage.go`中的函数

之后用实现的接口去实现`raw_api.go`

一开始写的时候在函数内部调用了`server.storage.start`和`server.storage.close`.但是结果不对，想了一下这个应该在函数外部调用.不是功能的一部分

遇到的主要困难是不熟悉GO语言,写代码效率很低,需要慢慢熟悉

### Project2

#### 2A

 - Raftlog中的index包括了storage中的和entries中的，是共用的index,所以访问entries中的数据时需要根据index和firstindex等计算出正确的下标

 - 一开始commit在handleAppendEntriesResponse时处理的，但是这样单个节点时无法更新commit,就特殊处理了一下,在sendAppend2All中处理了

 - newRaft里初始化时还要用到HardState里的信息

 - 多轮选举,vote相关的数据没有清空,由于统计选票是否过半的操作是在响应voteResponse时实现的,残留的数据会影响下一轮的选举

#### 2B

- 报错` panic: find no region for 30203030303030303030`

    2A中newRaft初始化存在问题，`Prs` 必须从 `confState` 中取，不然根本不知道集群中有哪些 `peer`,更改后`panic`消失

- handleAppendEntries中的response中index没有完全初始化,2A中应当只包含正常返回的情况

- append之后还要更新peerstorage中的raftState数据,而且要记得`SetMeta`写进去

#### 2C

- `proposeRaftCommand`序列化和`HandleRaftReady`反序列化的时候两边类型没对上,序列化的是req,反序列化的是msg,一直panic,看了好久才发现

#### Project 4

提供了三种CF：`default`：记录values  `write`：记录操作  `lock`：记录锁

每个事务以开始时间戳唯一标识（唯一的）

每个事务和一个primary key挂钩，事务如何处理取决于primary key如何处理。其他key参照primary key的操作来进行。



- txn储存完所有的修改之后记得将修改写入storage

- `KvCheckTxnStatus`的几种情况：（结合前面的`prewrite`和`commit`）
  - 已经commit（能查询到非rollback的write），NoAction
  
  - 无锁，已经回滚，NoAction
  
  - 无锁，未回滚，LockNotExistRollback
  
  - 有锁，锁超时，TTLExpireRollback

- `getvalue`之前要查询这之前的`write`，如果是`put`操作才有值

- 记得在每次rollback后将修改写入storage,或者独立成一个函数比较好

## 8.2

进度：3A 3C过, 3B`0`概率过

#### 3A

- LeaderTransfer不为None时,说明还处于领导者变更阶段，不能接受任何propose;同时要记得重置leadTransferee,否则永远不会接受propose

- MessageType_MsgTransferLeader可能会发给follower,要处理这种情况，把message重新发给leader

- 发现在测试中会有一个raft的peers中不包含自己的情况，想象不出来为啥会有这种情况


#### 3C


- 文档中提到用`RaftCluster.core.PutRegion`等函数更新本地储存,实际上`RaftCluster`的成员函数中又对这些函数的包装,这些函数进行了上锁,可以直接使用.

- `processRegionHeartbeat`中获取region的RegionEpoch,有为nil的情况.开始因为找没找到合适的err,这种情况我随便返回了一个`errors.Errorf`,结果运行五十次有六次一个测试点FAIL;改为返回nil后,五十次测试全部通过.

  这背后的意义我还不是很明确

  另外下面测试点有几次测试耗时是其他测试的几十倍,不知道这是否正常
  ```
  OK: 18 passed
  --- PASS: TestServer (61.03s)
  PASS
  ok  	github.com/pingcap-incubator/tinykv/scheduler/server	61.042s
  ```



- Balance操作
  - 如果找到的待移动的`region`小于`GetMaxReplicas`,不必balance,没有必要
  - 按size从小到大找targetStore时,如果一个store中包含所转移region的peer,那么略过.因为同一个store中包含两个相同的peer是没有意义的


  #### 3B

- Transfer不需要propose,直接调用TransferLeader后`cb.Done`就行

- 要更改`RegionLocalState` ，包括`RegionEpoch`和`Region`中的`Peers`,修改后通过kvWB写入
  
  还要更新`GlobalContext`的`storeMeta`中的区域状态,这个是Global的,操作前要上锁.

- confChange通过`raft.RawNode.ProposeConfChange`来propose,需要输入一个`pb.ConfChange`,`req`可以序列化后存入`Context`


- BasicConfChange中一直Timeout,发现是sendHeartBeat实现有问题,MsgHeartBeat的commit字段必须为`util.RaftInvalidIndex`